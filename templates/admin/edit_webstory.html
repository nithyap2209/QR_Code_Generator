{% extends 'admin/base.html' %}

{% block title %}Edit Web Story - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Live Preview Section (Left Side) -->
        <div class="col-lg-4 col-md-5 mb-4">
            <div class="card shadow-sm border-0 sticky-preview">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 text-primary">
                        <i class="fas fa-eye me-2"></i>Live Preview
                    </h6>
                </div>
                <div class="card-body p-0">
                    <!-- Story Viewer Preview -->
                    <div class="preview-container">
                        <div class="story-preview-viewer">
                            <div class="story-preview-container">
                                <!-- Preview Slide Container -->
                                <div id="previewSlidesContainer">
                                    <!-- Default empty state -->
                                    <div class="preview-empty-state" id="previewEmptyState" {% if webstory.slides %}style="display: none;"{% endif %}>
                                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Add slides to see preview</p>
                                    </div>
                                </div>

                                <!-- Preview Navigation -->
                                <div class="preview-navigation" id="previewNavigation" style="display: {% if webstory.slides %}flex{% else %}none{% endif %};">
                                    <button type="button" class="preview-nav-btn preview-prev" onclick="previewPrevSlide()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="preview-slide-indicator" id="previewIndicator">
                                        <span id="currentPreviewSlide">1</span> / <span id="totalPreviewSlides">{{ webstory.slides|length if webstory.slides else 0 }}</span>
                                    </div>
                                    <button type="button" class="preview-nav-btn preview-next" onclick="previewNextSlide()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section (Right Side) -->
        <div class="col-lg-8 col-md-7">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-edit me-2"></i>Edit Web Story
                        </h5>
                        <a href="{{ url_for('admin.admin_webstories') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Web Stories
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('admin.admin_edit_webstory', id=webstory.id) }}" enctype="multipart/form-data" id="webstoryForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="slide_count" id="slide_count" value="{{ webstory.slides|length if webstory.slides else 0 }}">

                        <!-- Tabs -->
                        <ul class="nav nav-tabs mb-4" id="webstoryTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                    General
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="slides-tab" data-bs-toggle="tab" data-bs-target="#slides" type="button" role="tab">
                                    Slide
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="webstoryTabContent">
                            <!-- General Tab -->
                            <div class="tab-pane fade show active" id="general" role="tabpanel">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="meta_title" class="form-label fw-semibold">
                                            Meta Title <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="meta_title" name="meta_title"
                                               value="{{ webstory.meta_title }}" placeholder="Meta Title" required>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="meta_description" class="form-label fw-semibold">
                                            Meta Description <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="meta_description" name="meta_description"
                                                  rows="3" placeholder="Meta Description" required>{{ webstory.meta_description }}</textarea>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="cover_image" class="form-label fw-semibold">Cover Image</label>
                                        {% if webstory.cover_image %}
                                            <div class="mb-2">
                                                <img src="{{ url_for('static', filename='uploads/webstories/' + webstory.cover_image) }}"
                                                     class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                            </div>
                                        {% endif %}
                                        <input type="file" class="form-control" id="cover_image" name="cover_image" accept="image/*">
                                        <small class="form-text text-muted">Recommended size: 1080x1920px (9:16 aspect ratio)</small>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="slug" class="form-label fw-semibold">
                                            Slug <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="slug" name="slug"
                                               value="{{ webstory.slug }}" placeholder="-slug" required>
                                        <small class="form-text text-muted">URL-friendly version</small>
                                        <div id="slugFeedback" class="mt-1"></div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="publish_date" class="form-label fw-semibold">
                                            Publish Date <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" id="publish_date" name="publish_date"
                                               value="{{ webstory.publish_date.strftime('%Y-%m-%d') if webstory.publish_date else '' }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="status" class="form-label fw-semibold">Status <span class="text-danger">*</span></label>
                                        <div class="form-check form-switch mt-2">
                                            <input class="form-check-input" type="checkbox" id="status" name="status" {% if webstory.status %}checked{% endif %}>
                                            <label class="form-check-label" for="status">
                                                Active
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Slides Tab -->
                            <div class="tab-pane fade" id="slides" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-muted mb-0">Manage Slides</h6>
                                    <button type="button" class="btn btn-success btn-sm" onclick="addSlide()">
                                        <i class="fas fa-plus me-1"></i>Add Slide
                                    </button>
                                </div>

                                <div id="slidesContainer">
                                    {% if webstory.slides %}
                                        {% for slide in webstory.slides %}
                                        <div class="slide-card" id="slide_{{ loop.index0 }}">
                                            <div class="slide-header">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-grip-vertical drag-handle me-2"></i>
                                                    Slide #{{ loop.index }}
                                                </h6>
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeSlide({{ loop.index0 }})">
                                                    <i class="fas fa-trash"></i> Remove
                                                </button>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Image <span class="text-danger">*</span></label>
                                                    {% if slide.image %}
                                                        <div class="mb-2">
                                                            <img src="{{ slide.image }}" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                                        </div>
                                                    {% endif %}
                                                    <input type="file" class="form-control slide-image-input" name="slide_image_{{ loop.index0 }}"
                                                           accept="image/*" onchange="handleSlideImageUpload({{ loop.index0 }}, this)">
                                                    <input type="hidden" name="slide_{{ loop.index0 }}_image" id="slide_{{ loop.index0 }}_image_url" value="{{ slide.image }}">
                                                    <small class="form-text text-muted">Recommended: 1080x1920px</small>
                                                    <div id="slide_{{ loop.index0 }}_preview" class="mt-2"></div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Image Alt</label>
                                                    <input type="text" class="form-control" name="slide_{{ loop.index0 }}_image_alt"
                                                           value="{{ slide.image_alt }}" placeholder="Image Alt Text">
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label class="form-label fw-semibold">Content Spacing Top (px)</label>
                                                    <input type="number" class="form-control" name="slide_{{ loop.index0 }}_content_spacing_top"
                                                           value="{{ slide.content_spacing_top }}" placeholder="75">
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label class="form-label fw-semibold">Heading</label>
                                                    <div class="ck-editor-wrapper" id="heading_wrapper_{{ loop.index0 }}">
                                                        <textarea class="form-control slide-heading-editor" name="slide_{{ loop.index0 }}_heading" id="slide_{{ loop.index0 }}_heading"
                                                               placeholder="Slide Heading">{{ slide.heading }}</textarea>
                                                    </div>
                                                    <input type="hidden" name="slide_{{ loop.index0 }}_heading_bg" id="slide_{{ loop.index0 }}_heading_bg" value="{{ slide.heading_bg or 'rgba(0,0,0,0.3)' }}">
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-12">
                                                    <label class="form-label fw-semibold">Text</label>
                                                    <div class="ck-editor-wrapper" id="text_wrapper_{{ loop.index0 }}">
                                                        <textarea class="form-control slide-text-editor" name="slide_{{ loop.index0 }}_text" id="slide_{{ loop.index0 }}_text" rows="3"
                                                                  placeholder="Slide Text Content">{{ slide.text }}</textarea>
                                                    </div>
                                                    <input type="hidden" name="slide_{{ loop.index0 }}_text_bg" id="slide_{{ loop.index0 }}_text_bg" value="{{ slide.text_bg or 'rgba(0,0,0,0.3)' }}">
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Learn More URL</label>
                                                    <input type="url" class="form-control" name="slide_{{ loop.index0 }}_learn_more_url"
                                                           value="{{ slide.learn_more_url }}" placeholder="https://example.com">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label fw-semibold">Sort Order</label>
                                                    <input type="number" class="form-control" name="slide_{{ loop.index0 }}_sort_order"
                                                           value="{{ slide.sort_order }}">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label fw-semibold">Status</label>
                                                    <div class="form-check form-switch mt-2">
                                                        <input class="form-check-input" type="checkbox" name="slide_{{ loop.index0 }}_status" {% if slide.status %}checked{% endif %}>
                                                        <label class="form-check-label">Active</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Hidden position fields -->
                                            <input type="hidden" name="slide_{{ loop.index0 }}_heading_left" value="{{ slide.heading_left or '' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_heading_bottom" value="{{ slide.heading_bottom or '' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_heading_width" id="slide_{{ loop.index0 }}_heading_width" value="{{ slide.heading_width or '85%' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_heading_height" id="slide_{{ loop.index0 }}_heading_height" value="{{ slide.heading_height or 'auto' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_heading_font_size" id="slide_{{ loop.index0 }}_heading_font_size" value="{{ slide.heading_font_size or '18px' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_text_left" value="{{ slide.text_left or '' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_text_bottom" value="{{ slide.text_bottom or '' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_text_width" id="slide_{{ loop.index0 }}_text_width" value="{{ slide.text_width or '85%' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_text_height" id="slide_{{ loop.index0 }}_text_height" value="{{ slide.text_height or 'auto' }}">
                                            <input type="hidden" name="slide_{{ loop.index0 }}_text_font_size" id="slide_{{ loop.index0 }}_text_font_size" value="{{ slide.text_font_size or '14px' }}">
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>

                                {% if not webstory.slides or webstory.slides|length == 0 %}
                                <div id="noSlidesMessage" class="text-center py-5">
                                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No slides added yet. Click "Add Slide" to get started.</p>
                                </div>
                                {% else %}
                                <div id="noSlidesMessage" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No slides added yet. Click "Add Slide" to get started.</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-save me-2"></i>Update Web Story
                                    </button>
                                    <a href="{{ url_for('admin.admin_webstories') }}" class="btn btn-outline-secondary px-4">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Live Preview Styles */
    .sticky-preview {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow: hidden;
    }

    .preview-container {
        background: #000;
        position: relative;
        width: 100%;
        padding-bottom: 177.78%; /* 9:16 aspect ratio */
        overflow: hidden;
    }

    .story-preview-viewer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .story-preview-container {
        position: relative;
        width: 100%;
        height: 100%;
        background: #000;
    }

    .preview-slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    .preview-slide.active {
        display: block;
    }

    /* Draggable preview slide */
    .preview-slide {
        cursor: grab;
    }

    .preview-slide:active {
        cursor: grabbing;
    }

    .preview-slide.dragging {
        cursor: grabbing !important;
    }

    .preview-slide.dragging .preview-image-hint {
        opacity: 0;
    }

    /* Image adjustment hint in preview */
    .preview-image-hint {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 25;
        opacity: 0;
        transition: opacity 0.3s;
        white-space: nowrap;
    }

    .preview-slide:hover .preview-image-hint {
        opacity: 1;
    }

    .preview-reset-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.2s;
    }

    .preview-reset-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Preview Header Styles */
    .preview-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 15;
        padding: 0.75rem;
        color: #fff;
    }

    .preview-progress {
        flex: 1;
        display: flex;
        gap: 4px;
    }

    .preview-progress-bar {
        flex: 1;
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        overflow: hidden;
    }

    .preview-progress-bar.active .preview-progress-fill {
        width: 100%;
    }

    .preview-progress-bar.completed .preview-progress-fill {
        width: 100%;
    }

    .preview-progress-fill {
        height: 100%;
        background: #fff;
        width: 0;
        border-radius: 2px;
    }

    .preview-close-btn {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 1rem;
        cursor: default;
        padding: 0.25rem;
        opacity: 0.8;
    }

    .preview-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        color: #fff;
        pointer-events: none;
    }

    .preview-content {
        position: relative;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }

    .preview-heading {
        position: absolute;
        font-size: 18px;
        font-weight: 400;
        line-height: 1.25;
        color: #fff;
        text-align: center;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 8px;
        cursor: move;
        pointer-events: auto;
        left: 50%;
        bottom: 12%;
        transform: translateX(-50%);
        width: 85%;
        min-width: 50px;
        min-height: 30px;
        user-select: none;
        border: 2px dashed transparent;
        transition: border-color 0.2s;
        box-sizing: border-box;
        overflow: hidden;
    }

    .preview-heading:hover,
    .preview-heading.dragging,
    .preview-heading.resizing {
        border-color: rgba(255, 255, 255, 0.5);
    }

    .preview-text {
        position: absolute;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.35;
        color: #fff;
        text-align: center;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 8px;
        cursor: move;
        pointer-events: auto;
        left: 50%;
        bottom: 6%;
        transform: translateX(-50%);
        width: 85%;
        min-width: 50px;
        min-height: 30px;
        user-select: none;
        border: 2px dashed transparent;
        transition: border-color 0.2s;
        box-sizing: border-box;
        overflow: hidden;
    }

    .preview-text:hover,
    .preview-text.dragging,
    .preview-text.resizing {
        border-color: rgba(255, 255, 255, 0.5);
    }

    /* Text content wrapper for auto-scaling */
    .text-content-wrapper {
        display: block;
        width: 100%;
        height: 100%;
        overflow: hidden;
        word-wrap: break-word;
        word-break: break-word;
    }

    /* Remove paragraph margins inside preview elements */
    .preview-heading p,
    .preview-text p {
        margin: 0;
        padding: 0;
    }

    .preview-heading .text-content-wrapper p,
    .preview-text .text-content-wrapper p {
        margin: 0;
        padding: 0;
    }

    /* Formatting styles for CKEditor content in preview */
    .preview-heading strong,
    .preview-heading b,
    .preview-text strong,
    .preview-text b,
    .preview-heading .text-content-wrapper strong,
    .preview-heading .text-content-wrapper b,
    .preview-text .text-content-wrapper strong,
    .preview-text .text-content-wrapper b {
        font-weight: 700 !important;
    }

    .preview-heading i,
    .preview-heading em,
    .preview-text i,
    .preview-text em,
    .preview-heading .text-content-wrapper i,
    .preview-heading .text-content-wrapper em,
    .preview-text .text-content-wrapper i,
    .preview-text .text-content-wrapper em {
        font-style: italic !important;
    }

    .preview-heading a,
    .preview-text a,
    .preview-heading .text-content-wrapper a,
    .preview-text .text-content-wrapper a {
        color: #93c5fd !important;
        text-decoration: underline !important;
    }

    /* List styles for preview */
    .preview-heading ul,
    .preview-text ul,
    .preview-heading .text-content-wrapper ul,
    .preview-text .text-content-wrapper ul {
        list-style-type: disc !important;
        list-style-position: inside;
        padding-left: 0.5rem;
        margin: 0.25rem 0;
        text-align: left;
    }

    .preview-heading ol,
    .preview-text ol,
    .preview-heading .text-content-wrapper ol,
    .preview-text .text-content-wrapper ol {
        list-style-type: decimal !important;
        list-style-position: inside;
        padding-left: 0.5rem;
        margin: 0.25rem 0;
        text-align: left;
    }

    .preview-heading li,
    .preview-text li,
    .preview-heading .text-content-wrapper li,
    .preview-text .text-content-wrapper li {
        display: list-item !important;
        margin-bottom: 0.15rem;
    }

    /* Resize Handle Styles */
    .resize-handle {
        position: absolute;
        background: #fff;
        border: 2px solid #007bff;
        z-index: 100;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: auto;
    }

    .preview-heading:hover .resize-handle,
    .preview-text:hover .resize-handle,
    .preview-heading.resizing .resize-handle,
    .preview-text.resizing .resize-handle {
        opacity: 1;
    }

    .resize-handle-e {
        width: 10px;
        height: 30px;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        cursor: ew-resize;
        border-radius: 0 4px 4px 0;
    }

    .resize-handle-w {
        width: 10px;
        height: 30px;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        cursor: ew-resize;
        border-radius: 4px 0 0 4px;
    }

    .resize-handle-s {
        width: 30px;
        height: 10px;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        cursor: ns-resize;
        border-radius: 0 0 4px 4px;
    }

    .resize-handle-se {
        width: 14px;
        height: 14px;
        right: 0;
        bottom: 0;
        cursor: nwse-resize;
        border-radius: 0 0 4px 0;
    }

    .resize-handle-sw {
        width: 14px;
        height: 14px;
        left: 0;
        bottom: 0;
        cursor: nesw-resize;
        border-radius: 0 0 0 4px;
    }

    .preview-link-container {
        position: absolute;
        left: 50%;
        bottom: 3%;
        transform: translateX(-50%);
        pointer-events: auto;
    }

    .preview-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.35rem;
        background: #fff;
        color: #273879;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
        margin: 0 auto;
        width: fit-content;
    }

    .preview-empty-state {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #666;
    }

    .preview-navigation {
        position: absolute;
        bottom: 15px;
        left: 10px;
        right: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        z-index: 20;
    }

    .preview-nav-btn {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        color: #273879;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        flex-shrink: 0;
    }

    .preview-nav-btn:hover {
        background: #fff;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .preview-nav-btn i {
        font-size: 14px;
    }

    .preview-slide-indicator {
        background: rgba(255, 255, 255, 0.95);
        padding: 0.35rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: #273879;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Form Styles */
    .form-label {
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #4895ef;
        box-shadow: 0 0 0 0.2rem rgba(72, 149, 239, 0.25);
    }

    .card {
        border-radius: 12px;
    }

    .slide-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #f8f9fa;
        position: relative;
    }

    .slide-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }

    .slide-header .btn-danger {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .drag-handle {
        cursor: move;
        color: #6c757d;
    }

    .ck-editor__editable {
        min-height: 100px;
    }

    /* Custom Color Picker Button Styles */
    .ck-editor-wrapper {
        position: relative;
    }

    .ck-color-picker-btn {
        position: absolute;
        top: 1px;
        right: 1px;
        z-index: 10;
        width: 32px;
        height: 32px;
        border: none;
        background: #f0f0f0;
        border-radius: 0 4px 0 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    .ck-color-picker-btn:hover {
        background: #e0e0e0;
    }

    .ck-color-picker-btn input[type="color"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .ck-color-picker-btn .color-icon {
        width: 18px;
        height: 18px;
        border-radius: 3px;
        border: 1px solid #ccc;
        pointer-events: none;
    }

    .color-picker-label {
        font-size: 11px;
        color: #666;
        margin-top: 2px;
    }

    /* Adjust CKEditor toolbar to make room for color picker */
    .ck-editor-wrapper .ck.ck-toolbar {
        padding-right: 40px !important;
    }
</style>

<!-- CKEditor 5 -->
<script src="https://cdn.ckeditor.com/ckeditor5/40.1.0/classic/ckeditor.js"></script>

<script>
    let slideCounter = {{ webstory.slides|length if webstory.slides else 0 }};
    let currentPreviewSlide = 0;
    let previewSlides = [];
    let editorInstances = {}; // Store CKEditor instances

    // Store base font sizes for scaling
    const baseFontSizes = {
        heading: 18,
        text: 14
    };

    // Store original dimensions for font scaling reference
    const originalDimensions = {};

    // Debounce function to prevent excessive updates
    const debounceTimers = {};
    function debounce(func, wait, key) {
        return function(...args) {
            if (debounceTimers[key]) {
                clearTimeout(debounceTimers[key]);
            }
            debounceTimers[key] = setTimeout(() => {
                func.apply(this, args);
            }, wait);
        };
    }

    // Create debounced version of updatePreviewSlide
    function debouncedUpdatePreview(slideIndex) {
        const key = `preview_${slideIndex}`;
        if (debounceTimers[key]) {
            clearTimeout(debounceTimers[key]);
        }
        debounceTimers[key] = setTimeout(() => {
            updatePreviewSlide(slideIndex);
        }, 150);
    }

    // Function to add color picker button to CKEditor toolbar
    function addColorPickerToEditor(wrapperId, hiddenInputId, slideIndex, type) {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;

        // Create color picker button
        const colorBtn = document.createElement('div');
        colorBtn.className = 'ck-color-picker-btn';
        colorBtn.title = 'Background Color';
        
        // Get current color from hidden input
        const hiddenInput = document.getElementById(hiddenInputId);
        const currentColor = hiddenInput ? hiddenInput.value : 'rgba(0,0,0,0.3)';
        
        // Convert rgba to hex for color input
        let hexColor = '#000000';
        if (currentColor.startsWith('rgba')) {
            const match = currentColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (match) {
                hexColor = '#' + [match[1], match[2], match[3]].map(x => {
                    const hex = parseInt(x).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            }
        } else if (currentColor.startsWith('#')) {
            hexColor = currentColor;
        }

        colorBtn.innerHTML = `
            <input type="color" value="${hexColor}" id="color_picker_${type}_${slideIndex}">
            <span class="color-icon" style="background-color: ${currentColor};"></span>
        `;

        wrapper.appendChild(colorBtn);

        // Add event listener for color change
        const colorInput = colorBtn.querySelector('input[type="color"]');
        const colorIcon = colorBtn.querySelector('.color-icon');
        
        colorInput.addEventListener('input', function() {
            const hex = this.value;
            // Convert hex to rgba with 0.3 opacity
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const rgbaColor = `rgba(${r},${g},${b},0.3)`;

            // Update hidden input
            if (hiddenInput) {
                hiddenInput.value = rgbaColor;
            }

            // Update color icon
            colorIcon.style.backgroundColor = rgbaColor;

            // Update preview with debouncing
            debouncedUpdatePreview(slideIndex);
        });
    }

    // Auto-scale text to fit container
    function fitTextToContainer(element, type) {
        if (!element) return;

        const container = element.closest('.preview-slide');
        if (!container) return;

        const slideIndex = element.dataset.slide;
        const key = `${type}_${slideIndex}`;
        
        // Get content wrapper or create one
        let contentWrapper = element.querySelector('.text-content-wrapper');
        if (!contentWrapper) {
            // Wrap existing content
            const handles = element.querySelectorAll('.resize-handle');
            const handlesHTML = Array.from(handles).map(h => h.outerHTML).join('');
            const content = element.innerHTML.replace(/<div class="resize-handle[^>]*><\/div>/g, '');
            
            element.innerHTML = `<span class="text-content-wrapper">${content}</span>${handlesHTML}`;
            contentWrapper = element.querySelector('.text-content-wrapper');
        }

        // Store original dimensions on first call
        if (!originalDimensions[key]) {
            originalDimensions[key] = {
                width: element.offsetWidth,
                height: element.offsetHeight,
                fontSize: baseFontSizes[type]
            };
        }

        const original = originalDimensions[key];
        const currentWidth = element.offsetWidth;
        const currentHeight = element.offsetHeight;

        // Calculate scale based on width ratio
        const widthRatio = currentWidth / original.width;
        
        // Calculate new font size (with min/max limits)
        let newFontSize = original.fontSize * widthRatio;
        newFontSize = Math.max(8, Math.min(newFontSize, baseFontSizes[type] * 1.5)); // Min 8px, max 1.5x original

        // Apply the new font size
        element.style.fontSize = newFontSize + 'px';

        // Also adjust line height proportionally
        const lineHeightRatio = type === 'heading' ? 1.25 : 1.35;
        element.style.lineHeight = lineHeightRatio;

        // Save font size to hidden input
        const fontSizeInput = document.getElementById(`slide_${slideIndex}_${type}_font_size`);
        if (fontSizeInput) fontSizeInput.value = newFontSize + 'px';
    }

    // Auto-generate slug from meta title
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.getElementById('meta_title');
        const slugInput = document.getElementById('slug');
        let manuallyEdited = true; // Set to true for edit mode

        function generateSlug(text) {
            return text
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
        }

        titleInput.addEventListener('input', function() {
            if (!manuallyEdited) {
                slugInput.value = generateSlug(this.value);
                checkSlugAvailability(slugInput.value);
            }
        });

        slugInput.addEventListener('input', function() {
            manuallyEdited = true;
            checkSlugAvailability(this.value);
        });

        slugInput.addEventListener('blur', function() {
            checkSlugAvailability(this.value);
        });

        // Initialize CKEditor for existing slides and setup preview
        {% if webstory.slides %}
        {% for slide in webstory.slides %}
        // Add preview slide for existing slide {{ loop.index0 }}
        addPreviewSlide({{ loop.index0 }}, '{{ slide.image }}', `{{ slide.heading|safe|replace('`', '\\`') }}`, `{{ slide.text|safe|replace('`', '\\`') }}`, '{{ slide.learn_more_url }}', '{{ slide.heading_left or '' }}', '{{ slide.heading_bottom or '' }}', '{{ slide.text_left or '' }}', '{{ slide.text_bottom or '' }}', '{{ slide.heading_bg or 'rgba(0,0,0,0.3)' }}', '{{ slide.text_bg or 'rgba(0,0,0,0.3)' }}', '{{ slide.heading_width or '85%' }}', '{{ slide.heading_height or 'auto' }}', '{{ slide.text_width or '85%' }}', '{{ slide.text_height or 'auto' }}', '{{ slide.heading_font_size or '18px' }}', '{{ slide.text_font_size or '14px' }}');

        // Initialize heading editor for slide {{ loop.index0 }}
        ClassicEditor
            .create(document.querySelector('#slide_{{ loop.index0 }}_heading'), {
                toolbar: ['bold', 'italic', 'link', '|', 'undo', 'redo'],
                placeholder: 'Enter slide heading...'
            })
            .then(editor => {
                editorInstances['heading_{{ loop.index0 }}'] = editor;
                // Listen for changes with debouncing
                editor.model.document.on('change:data', () => {
                    debouncedUpdatePreview({{ loop.index0 }});
                });
                // Add color picker button to heading toolbar
                addColorPickerToEditor('heading_wrapper_{{ loop.index0 }}', 'slide_{{ loop.index0 }}_heading_bg', {{ loop.index0 }}, 'heading');
            })
            .catch(error => {
                console.error('Error initializing heading editor for slide {{ loop.index0 }}:', error);
            });

        // Initialize text editor for slide {{ loop.index0 }}
        ClassicEditor
            .create(document.querySelector('#slide_{{ loop.index0 }}_text'), {
                toolbar: [
                    'bold', 'italic', 'link', '|',
                    'bulletedList', 'numberedList', '|',
                    'undo', 'redo'
                ],
                placeholder: 'Enter slide text content...'
            })
            .then(editor => {
                editorInstances['text_{{ loop.index0 }}'] = editor;
                // Listen for changes with debouncing
                editor.model.document.on('change:data', () => {
                    debouncedUpdatePreview({{ loop.index0 }});
                });
                // Add color picker button to text toolbar
                addColorPickerToEditor('text_wrapper_{{ loop.index0 }}', 'slide_{{ loop.index0 }}_text_bg', {{ loop.index0 }}, 'text');
            })
            .catch(error => {
                console.error('Error initializing text editor for slide {{ loop.index0 }}:', error);
            });

        // Add event listeners for other fields with debouncing
        document.querySelector('input[name="slide_{{ loop.index0 }}_learn_more_url"]').addEventListener('input', () => {
            debouncedUpdatePreview({{ loop.index0 }});
        });
        {% endfor %}
        {% endif %}
    });

    // Debounce function to avoid too many API calls
    let slugCheckTimeout;
    function checkSlugAvailability(slug) {
        clearTimeout(slugCheckTimeout);

        const feedbackDiv = document.getElementById('slugFeedback');
        const slugInput = document.getElementById('slug');

        if (!slug || slug.trim() === '') {
            feedbackDiv.innerHTML = '';
            slugInput.classList.remove('is-valid', 'is-invalid');
            return;
        }

        // Show loading state
        feedbackDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Checking availability...</small>';

        slugCheckTimeout = setTimeout(function() {
            fetch('{{ url_for("admin.admin_webstory_check_slug") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    slug: slug,
                    webstory_id: {{ webstory.id }}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedbackDiv.innerHTML = '<small class="text-success"><i class="fas fa-check-circle me-1"></i>' + data.message + '</small>';
                    slugInput.classList.remove('is-invalid');
                    slugInput.classList.add('is-valid');
                } else {
                    let message = '<small class="text-danger"><i class="fas fa-times-circle me-1"></i>' + data.message;
                    if (data.suggestion) {
                        message += '. <a href="#" onclick="useSuggestedSlug(\'' + data.suggestion + '\'); return false;">Use "' + data.suggestion + '"?</a>';
                    }
                    message += '</small>';
                    feedbackDiv.innerHTML = message;
                    slugInput.classList.remove('is-valid');
                    slugInput.classList.add('is-invalid');
                }
            })
            .catch(error => {
                console.error('Error checking slug:', error);
                feedbackDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error checking slug availability</small>';
            });
        }, 500); // Wait 500ms after user stops typing
    }

    function useSuggestedSlug(slug) {
        const slugInput = document.getElementById('slug');
        slugInput.value = slug;
        checkSlugAvailability(slug);
    }

    function addSlide() {
        const container = document.getElementById('slidesContainer');
        const noSlidesMsg = document.getElementById('noSlidesMessage');

        if (noSlidesMsg) {
            noSlidesMsg.style.display = 'none';
        }

        const slideDiv = document.createElement('div');
        slideDiv.className = 'slide-card';
        slideDiv.id = `slide_${slideCounter}`;
        slideDiv.innerHTML = `
            <div class="slide-header">
                <h6 class="mb-0">
                    <i class="fas fa-grip-vertical drag-handle me-2"></i>
                    Slide #${slideCounter + 1}
                </h6>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSlide(${slideCounter})">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Image <span class="text-danger">*</span></label>
                    <input type="file" class="form-control slide-image-input" name="slide_image_${slideCounter}"
                           accept="image/*" onchange="handleSlideImageUpload(${slideCounter}, this)" required>
                    <input type="hidden" name="slide_${slideCounter}_image" id="slide_${slideCounter}_image_url">
                    <small class="form-text text-muted">Recommended: 1080x1920px</small>
                    <div id="slide_${slideCounter}_preview" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Image Alt</label>
                    <input type="text" class="form-control" name="slide_${slideCounter}_image_alt"
                           placeholder="Image Alt Text">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label fw-semibold">Content Spacing Top (px)</label>
                    <input type="number" class="form-control" name="slide_${slideCounter}_content_spacing_top"
                           value="75" placeholder="75">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label fw-semibold">Heading</label>
                    <div class="ck-editor-wrapper" id="heading_wrapper_${slideCounter}">
                        <textarea class="form-control slide-heading-editor" name="slide_${slideCounter}_heading" id="slide_${slideCounter}_heading"
                               placeholder="Slide Heading"></textarea>
                    </div>
                    <input type="hidden" name="slide_${slideCounter}_heading_bg" id="slide_${slideCounter}_heading_bg" value="rgba(0,0,0,0.3)">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label fw-semibold">Text</label>
                    <div class="ck-editor-wrapper" id="text_wrapper_${slideCounter}">
                        <textarea class="form-control slide-text-editor" name="slide_${slideCounter}_text" id="slide_${slideCounter}_text" rows="3"
                              placeholder="Slide Text Content"></textarea>
                    </div>
                    <input type="hidden" name="slide_${slideCounter}_text_bg" id="slide_${slideCounter}_text_bg" value="rgba(0,0,0,0.3)">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Learn More URL</label>
                    <input type="url" class="form-control" name="slide_${slideCounter}_learn_more_url"
                           placeholder="https://example.com">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sort Order</label>
                    <input type="number" class="form-control" name="slide_${slideCounter}_sort_order"
                           value="${slideCounter}">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Status</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" name="slide_${slideCounter}_status" checked>
                        <label class="form-check-label">Active</label>
                    </div>
                </div>
            </div>

            <!-- Hidden position fields -->
            <input type="hidden" name="slide_${slideCounter}_heading_left" value="">
            <input type="hidden" name="slide_${slideCounter}_heading_bottom" value="">
            <input type="hidden" name="slide_${slideCounter}_heading_width" id="slide_${slideCounter}_heading_width" value="85%">
            <input type="hidden" name="slide_${slideCounter}_heading_height" id="slide_${slideCounter}_heading_height" value="auto">
            <input type="hidden" name="slide_${slideCounter}_heading_font_size" id="slide_${slideCounter}_heading_font_size" value="18px">
            <input type="hidden" name="slide_${slideCounter}_text_left" value="">
            <input type="hidden" name="slide_${slideCounter}_text_bottom" value="">
            <input type="hidden" name="slide_${slideCounter}_text_width" id="slide_${slideCounter}_text_width" value="85%">
            <input type="hidden" name="slide_${slideCounter}_text_height" id="slide_${slideCounter}_text_height" value="auto">
            <input type="hidden" name="slide_${slideCounter}_text_font_size" id="slide_${slideCounter}_text_font_size" value="14px">
        `;

        container.appendChild(slideDiv);

        // Initialize CKEditor for the new slide's heading and text
        const currentSlideIndex = slideCounter;

        // Initialize heading editor
        ClassicEditor
            .create(document.querySelector(`#slide_${currentSlideIndex}_heading`), {
                toolbar: ['bold', 'italic', 'link', '|', 'undo', 'redo'],
                placeholder: 'Enter slide heading...'
            })
            .then(editor => {
                editorInstances[`heading_${currentSlideIndex}`] = editor;
                // Listen for changes with debouncing
                editor.model.document.on('change:data', () => {
                    debouncedUpdatePreview(currentSlideIndex);
                });
                // Add color picker button to heading toolbar
                addColorPickerToEditor(`heading_wrapper_${currentSlideIndex}`, `slide_${currentSlideIndex}_heading_bg`, currentSlideIndex, 'heading');
            })
            .catch(error => {
                console.error('Error initializing heading editor:', error);
            });

        // Initialize text editor
        ClassicEditor
            .create(document.querySelector(`#slide_${currentSlideIndex}_text`), {
                toolbar: [
                    'bold', 'italic', 'link', '|',
                    'bulletedList', 'numberedList', '|',
                    'undo', 'redo'
                ],
                placeholder: 'Enter slide text content...'
            })
            .then(editor => {
                editorInstances[`text_${currentSlideIndex}`] = editor;
                // Listen for changes with debouncing
                editor.model.document.on('change:data', () => {
                    debouncedUpdatePreview(currentSlideIndex);
                });
                // Add color picker button to text toolbar
                addColorPickerToEditor(`text_wrapper_${currentSlideIndex}`, `slide_${currentSlideIndex}_text_bg`, currentSlideIndex, 'text');
            })
            .catch(error => {
                console.error('Error initializing text editor:', error);
            });

        // Add event listeners for other fields with debouncing
        document.querySelector(`input[name="slide_${currentSlideIndex}_learn_more_url"]`).addEventListener('input', () => {
            debouncedUpdatePreview(currentSlideIndex);
        });

        // Add preview slide
        addPreviewSlide(currentSlideIndex);

        slideCounter++;
        document.getElementById('slide_count').value = slideCounter;
    }

    function removeSlide(index) {
        const slideDiv = document.getElementById(`slide_${index}`);
        if (slideDiv) {
            slideDiv.remove();
        }

        // Remove from preview
        removePreviewSlide(index);

        // Check if no slides remain
        const container = document.getElementById('slidesContainer');
        if (container.children.length === 0) {
            document.getElementById('noSlidesMessage').style.display = 'block';
        }
    }

    function handleSlideImageUpload(slideIndex, input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('upload', input.files[0]);

            fetch('{{ url_for("admin.admin_webstory_upload_image") }}', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.uploaded) {
                    document.getElementById(`slide_${slideIndex}_image_url`).value = result.url;

                    // Show preview
                    const preview = document.getElementById(`slide_${slideIndex}_preview`);
                    preview.innerHTML = `<img src="${result.url}" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">`;

                    // Update live preview
                    updatePreviewSlide(slideIndex);
                } else {
                    alert('Image upload failed: ' + (result.error ? result.error.message : 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                alert('Image upload failed: ' + error.message);
            });
        }
    }

    // Live Preview Functions
    function addPreviewSlide(slideIndex, imageUrl = '', headingContent = '', textContent = '', learnMoreUrl = '', headingLeft = '', headingBottom = '', textLeft = '', textBottom = '', headingBg = 'rgba(0,0,0,0.3)', textBg = 'rgba(0,0,0,0.3)', headingWidth = '85%', headingHeight = 'auto', textWidth = '85%', textHeight = 'auto', headingFontSize = '18px', textFontSize = '14px') {
        const container = document.getElementById('previewSlidesContainer');
        const emptyState = document.getElementById('previewEmptyState');

        if (emptyState) {
            emptyState.style.display = 'none';
        }

        const previewSlide = document.createElement('div');
        previewSlide.className = 'preview-slide';
        previewSlide.id = `preview_slide_${slideIndex}`;
        if (imageUrl) {
            previewSlide.style.backgroundImage = `url('${imageUrl}')`;
        }

        // Build heading style with saved positions
        let headingStyle = `display: ${headingContent ? 'block' : 'none'};`;
        if (headingLeft) {
            headingStyle += ` left: ${headingLeft}; transform: none;`;
        }
        if (headingBottom) {
            headingStyle += ` bottom: ${headingBottom};`;
        }
        if (headingBg) {
            headingStyle += ` background: ${headingBg};`;
        }
        if (headingWidth) {
            headingStyle += ` width: ${headingWidth};`;
        }
        if (headingHeight && headingHeight !== 'auto') {
            headingStyle += ` height: ${headingHeight};`;
        }
        if (headingFontSize) {
            headingStyle += ` font-size: ${headingFontSize};`;
        }

        // Build text style with saved positions
        let textStyle = `display: ${textContent ? 'block' : 'none'};`;
        if (textLeft) {
            textStyle += ` left: ${textLeft}; transform: none;`;
        }
        if (textBottom) {
            textStyle += ` bottom: ${textBottom};`;
        }
        if (textBg) {
            textStyle += ` background: ${textBg};`;
        }
        if (textWidth) {
            textStyle += ` width: ${textWidth};`;
        }
        if (textHeight && textHeight !== 'auto') {
            textStyle += ` height: ${textHeight};`;
        }
        if (textFontSize) {
            textStyle += ` font-size: ${textFontSize};`;
        }

        previewSlide.innerHTML = `
            <div class="preview-header">
                <div class="preview-progress" id="preview_progress_${slideIndex}">
                </div>
                <button type="button" class="preview-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- Image Adjustment Hint -->
            <div class="preview-image-hint" id="preview_image_hint_${slideIndex}">
                <i class="fas fa-mouse-pointer"></i> Drag to move &bull; Scroll to zoom
                <button type="button" class="preview-reset-btn" onclick="resetImagePosition(${slideIndex})" title="Reset">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
            <div class="preview-overlay">
                <div class="preview-content">
                    <div class="preview-heading" id="preview_heading_${slideIndex}"
                         data-slide="${slideIndex}"
                         style="${headingStyle}">
                        <span class="text-content-wrapper">${headingContent}</span>
                        <div class="resize-handle resize-handle-e" data-resize="e"></div>
                        <div class="resize-handle resize-handle-w" data-resize="w"></div>
                        <div class="resize-handle resize-handle-s" data-resize="s"></div>
                        <div class="resize-handle resize-handle-se" data-resize="se"></div>
                        <div class="resize-handle resize-handle-sw" data-resize="sw"></div>
                    </div>
                    <div class="preview-text" id="preview_text_${slideIndex}"
                         data-slide="${slideIndex}"
                         style="${textStyle}">
                        <span class="text-content-wrapper">${textContent}</span>
                        <div class="resize-handle resize-handle-e" data-resize="e"></div>
                        <div class="resize-handle resize-handle-w" data-resize="w"></div>
                        <div class="resize-handle resize-handle-s" data-resize="s"></div>
                        <div class="resize-handle resize-handle-se" data-resize="se"></div>
                        <div class="resize-handle resize-handle-sw" data-resize="sw"></div>
                    </div>
                    <div class="preview-link-container" id="preview_link_container_${slideIndex}">
                        <div id="preview_link_${slideIndex}">${learnMoreUrl ? `<a href="${learnMoreUrl}" class="preview-link" target="_blank">Learn More <i class="fas fa-arrow-right"></i></a>` : ''}</div>
                    </div>
                </div>
            </div>
        `;

        container.appendChild(previewSlide);
        previewSlides.push(slideIndex);

        // Setup mouse drag and zoom for this slide
        setupImageDragAndZoom(slideIndex);

        // Update progress bars for all slides
        updateAllProgressBars();

        // Make heading and text draggable and resizable
        makeDraggable(document.getElementById(`preview_heading_${slideIndex}`), slideIndex);
        makeDraggable(document.getElementById(`preview_text_${slideIndex}`), slideIndex);
        makeResizable(document.getElementById(`preview_heading_${slideIndex}`), slideIndex, 'heading');
        makeResizable(document.getElementById(`preview_text_${slideIndex}`), slideIndex, 'text');

        // Show navigation if more than 1 slide
        updatePreviewNavigation();

        // Show first slide
        if (previewSlides.length === 1) {
            showPreviewSlide(0);
        }
        
        // Apply initial text fitting for existing content
        setTimeout(() => {
            const headingEl = document.getElementById(`preview_heading_${slideIndex}`);
            const textEl = document.getElementById(`preview_text_${slideIndex}`);
            if (headingContent && headingEl) fitTextToContainer(headingEl, 'heading');
            if (textContent && textEl) fitTextToContainer(textEl, 'text');
        }, 100);
    }

    // Make elements draggable (both horizontal and vertical)
    function makeDraggable(element, slideIndex) {
        if (!element) return;

        let isDragging = false;
        let startX, startY, startLeft, startBottom;

        element.addEventListener('mousedown', function(e) {
            // Ignore if clicking on resize handle
            if (e.target.classList.contains('resize-handle')) return;
            
            isDragging = true;
            element.classList.add('dragging');

            startX = e.clientX;
            startY = e.clientY;

            const rect = element.getBoundingClientRect();
            const parentRect = element.parentElement.getBoundingClientRect();

            // Get current left position (convert from percentage/transform to pixels)
            const computedStyle = window.getComputedStyle(element);
            const currentLeft = element.offsetLeft;
            startLeft = currentLeft;
            startBottom = parentRect.bottom - rect.bottom;

            // Remove transform for free positioning
            element.style.transform = 'none';
            element.style.left = startLeft + 'px';

            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            const parentRect = element.parentElement.getBoundingClientRect();
            
            // Calculate new positions
            const newLeft = startLeft + deltaX;
            const newBottom = startBottom - deltaY;

            // Keep within bounds (both horizontal and vertical)
            const maxLeft = parentRect.width - element.offsetWidth;
            const maxBottom = parentRect.height - element.offsetHeight;
            
            const boundedLeft = Math.max(0, Math.min(newLeft, maxLeft));
            const boundedBottom = Math.max(0, Math.min(newBottom, maxBottom));

            // Update both positions
            element.style.left = boundedLeft + 'px';
            element.style.bottom = boundedBottom + 'px';
        });

        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                element.classList.remove('dragging');

                // Save position
                saveElementPosition(element, slideIndex);
            }
        });
    }

    // Make elements resizable using event delegation
    function makeResizable(element, slideIndex, type) {
        if (!element) return;

        let isResizing = false;
        let startX, startY, startWidth, startHeight, startLeft, resizeType;

        element.addEventListener('mousedown', function(e) {
            // Check if clicked on a resize handle
            if (!e.target.classList.contains('resize-handle')) return;
            
            isResizing = true;
            resizeType = e.target.dataset.resize;
            element.classList.add('resizing');

            startX = e.clientX;
            startY = e.clientY;
            startWidth = element.offsetWidth;
            startHeight = element.offsetHeight;
            startLeft = element.offsetLeft;

            // Remove transform for free positioning
            element.style.transform = 'none';
            element.style.left = startLeft + 'px';

            e.preventDefault();
            e.stopPropagation();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const parentRect = element.parentElement.getBoundingClientRect();
            
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;

            // Handle different resize directions
            if (resizeType && resizeType.includes('e')) {
                newWidth = Math.max(50, startWidth + deltaX);
            }
            if (resizeType && resizeType.includes('w')) {
                newWidth = Math.max(50, startWidth - deltaX);
                newLeft = startLeft + deltaX;
            }
            if (resizeType && resizeType.includes('s')) {
                newHeight = Math.max(30, startHeight + deltaY);
            }

            // Apply constraints
            const maxWidth = parentRect.width - 10;
            newWidth = Math.min(newWidth, maxWidth);
            
            // Keep left within bounds
            newLeft = Math.max(0, Math.min(newLeft, parentRect.width - newWidth));

            // Apply new dimensions in pixels
            element.style.width = newWidth + 'px';
            element.style.left = newLeft + 'px';
            
            if (resizeType && resizeType.includes('s')) {
                element.style.height = newHeight + 'px';
            }

            // Auto-scale text to fit container
            fitTextToContainer(element, type);
        });

        document.addEventListener('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                element.classList.remove('resizing');

                // Save size and position
                saveElementSize(element, slideIndex, type);
                saveElementPosition(element, slideIndex);
                
                // Final text fit adjustment
                fitTextToContainer(element, type);
            }
        });
    }

    // Save element size
    function saveElementSize(element, slideIndex, type) {
        const container = element.closest('.preview-slide');
        if (!container) return;

        const widthPx = element.offsetWidth;
        const heightPx = element.offsetHeight;

        // Store in hidden input fields
        const widthInput = document.getElementById(`slide_${slideIndex}_${type}_width`);
        const heightInput = document.getElementById(`slide_${slideIndex}_${type}_height`);
        const fontSizeInput = document.getElementById(`slide_${slideIndex}_${type}_font_size`);

        if (widthInput) widthInput.value = widthPx + 'px';
        if (heightInput) heightInput.value = heightPx + 'px';

        // Save font size
        const computedFontSize = window.getComputedStyle(element).fontSize;
        if (fontSizeInput && computedFontSize) fontSizeInput.value = computedFontSize;
    }

    // Save element position as percentage (both horizontal and vertical)
    function saveElementPosition(element, slideIndex) {
        const positionType = element.classList.contains('preview-heading') ? 'heading' : 'text';

        // Get container dimensions and convert to percentage
        const container = element.closest('.preview-slide');
        if (!container) return;

        const containerWidth = container.offsetWidth;
        const containerHeight = container.offsetHeight;
        
        const leftPx = parseFloat(element.style.left) || 0;
        const bottomPx = parseFloat(element.style.bottom) || 0;
        
        const leftPercent = (leftPx / containerWidth) * 100;
        const bottomPercent = (bottomPx / containerHeight) * 100;

        // Store in hidden input fields as percentage
        const leftInput = document.querySelector(`input[name="slide_${slideIndex}_${positionType}_left"]`);
        const bottomInput = document.querySelector(`input[name="slide_${slideIndex}_${positionType}_bottom"]`);

        if (leftInput) leftInput.value = leftPercent.toFixed(2) + '%';
        if (bottomInput) bottomInput.value = bottomPercent.toFixed(2) + '%';
    }

    function updatePreviewSlide(slideIndex) {
        const previewSlide = document.getElementById(`preview_slide_${slideIndex}`);
        if (!previewSlide) return;

        // Update image
        const imageUrl = document.getElementById(`slide_${slideIndex}_image_url`)?.value;
        if (imageUrl) {
            previewSlide.style.backgroundImage = `url('${imageUrl}')`;
        }

        // Update heading
        const headingEditor = editorInstances[`heading_${slideIndex}`];
        const headingElement = document.getElementById(`preview_heading_${slideIndex}`);
        if (headingEditor && headingElement) {
            const headingContent = headingEditor.getData();
            if (headingContent) {
                // Preserve resize handles when updating content
                updateElementContent(headingElement, headingContent);
                headingElement.style.display = 'block';
                
                // Apply text fitting after content update
                setTimeout(() => fitTextToContainer(headingElement, 'heading'), 10);
            } else {
                headingElement.style.display = 'none';
            }
            // Apply heading background color
            const headingBgInput = document.getElementById(`slide_${slideIndex}_heading_bg`);
            if (headingBgInput && headingBgInput.value) {
                headingElement.style.background = headingBgInput.value;
            }
            // Apply heading size
            const headingWidthInput = document.getElementById(`slide_${slideIndex}_heading_width`);
            const headingHeightInput = document.getElementById(`slide_${slideIndex}_heading_height`);
            if (headingWidthInput && headingWidthInput.value) {
                headingElement.style.width = headingWidthInput.value;
            }
            if (headingHeightInput && headingHeightInput.value && headingHeightInput.value !== 'auto') {
                headingElement.style.height = headingHeightInput.value;
            }
        }

        // Update text
        const textEditor = editorInstances[`text_${slideIndex}`];
        const textElement = document.getElementById(`preview_text_${slideIndex}`);
        if (textEditor && textElement) {
            const textContent = textEditor.getData();
            if (textContent) {
                // Preserve resize handles when updating content
                updateElementContent(textElement, textContent);
                textElement.style.display = 'block';
                
                // Apply text fitting after content update
                setTimeout(() => fitTextToContainer(textElement, 'text'), 10);
            } else {
                textElement.style.display = 'none';
            }
            // Apply text background color
            const textBgInput = document.getElementById(`slide_${slideIndex}_text_bg`);
            if (textBgInput && textBgInput.value) {
                textElement.style.background = textBgInput.value;
            }
            // Apply text size
            const textWidthInput = document.getElementById(`slide_${slideIndex}_text_width`);
            const textHeightInput = document.getElementById(`slide_${slideIndex}_text_height`);
            if (textWidthInput && textWidthInput.value) {
                textElement.style.width = textWidthInput.value;
            }
            if (textHeightInput && textHeightInput.value && textHeightInput.value !== 'auto') {
                textElement.style.height = textHeightInput.value;
            }
        }

        // Update learn more link
        const learnMoreUrl = document.querySelector(`input[name="slide_${slideIndex}_learn_more_url"]`)?.value;
        const linkElement = document.getElementById(`preview_link_${slideIndex}`);
        if (linkElement) {
            if (learnMoreUrl) {
                linkElement.innerHTML = `<a href="${learnMoreUrl}" class="preview-link" target="_blank">Learn More <i class="fas fa-arrow-right"></i></a>`;
            } else {
                linkElement.innerHTML = '';
            }
        }
    }

    // Update element content while preserving resize handles
    function updateElementContent(element, content) {
        // Get existing resize handles
        const handles = element.querySelectorAll('.resize-handle');
        const handlesHTML = Array.from(handles).map(h => h.outerHTML).join('');
        
        // Clear element and add content wrapper + handles
        element.innerHTML = `<span class="text-content-wrapper">${content}</span>${handlesHTML}`;
    }

    function showPreviewSlide(index) {
        if (previewSlides.length === 0) return;

        // Hide all slides
        document.querySelectorAll('.preview-slide').forEach(slide => {
            slide.classList.remove('active');
        });

        // Show current slide
        const slideIndex = previewSlides[index];
        const slide = document.getElementById(`preview_slide_${slideIndex}`);
        if (slide) {
            slide.classList.add('active');
            currentPreviewSlide = index;
            document.getElementById('currentPreviewSlide').textContent = index + 1;

            // Update progress bars
            updateAllProgressBars();
        }
    }

    function updatePreviewNavigation() {
        const navigation = document.getElementById('previewNavigation');
        const totalSlides = document.getElementById('totalPreviewSlides');

        totalSlides.textContent = previewSlides.length;

        if (previewSlides.length > 0) {
            navigation.style.display = 'flex';
        } else {
            navigation.style.display = 'none';
        }
    }

    function previewNextSlide() {
        if (currentPreviewSlide < previewSlides.length - 1) {
            showPreviewSlide(currentPreviewSlide + 1);
        } else {
            showPreviewSlide(0); // Loop back to first
        }
    }

    function previewPrevSlide() {
        if (currentPreviewSlide > 0) {
            showPreviewSlide(currentPreviewSlide - 1);
        } else {
            showPreviewSlide(previewSlides.length - 1); // Loop to last
        }
    }

    function removePreviewSlide(slideIndex) {
        const previewSlide = document.getElementById(`preview_slide_${slideIndex}`);
        if (previewSlide) {
            previewSlide.remove();
        }

        // Remove from array
        const arrayIndex = previewSlides.indexOf(slideIndex);
        if (arrayIndex > -1) {
            previewSlides.splice(arrayIndex, 1);
        }

        // Update navigation
        updatePreviewNavigation();

        // Update progress bars for remaining slides
        updateAllProgressBars();

        // Show empty state if no slides
        if (previewSlides.length === 0) {
            document.getElementById('previewEmptyState').style.display = 'block';
            currentPreviewSlide = 0;
        } else {
            // Show previous slide or first
            const newIndex = Math.min(currentPreviewSlide, previewSlides.length - 1);
            showPreviewSlide(newIndex);
        }
    }

    // Update progress bars for all preview slides
    function updateAllProgressBars() {
        previewSlides.forEach(slideIndex => {
            const progressContainer = document.getElementById(`preview_progress_${slideIndex}`);
            if (progressContainer) {
                // Generate progress bars based on total slides
                let progressBarsHTML = '';
                previewSlides.forEach((s, i) => {
                    const isCompleted = i < currentPreviewSlide ? 'completed' : '';
                    const isActive = i === currentPreviewSlide ? 'active' : '';
                    progressBarsHTML += `<div class="preview-progress-bar ${isCompleted} ${isActive}"><div class="preview-progress-fill"></div></div>`;
                });
                progressContainer.innerHTML = progressBarsHTML;
            }
        });
    }

    // Image adjustment state storage
    const imageAdjustments = {};
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let dragSlideIndex = null;

    // Initialize image adjustment for a slide
    function initImageAdjustment(slideIndex) {
        if (!imageAdjustments[slideIndex]) {
            imageAdjustments[slideIndex] = {
                posX: 50,
                posY: 50,
                zoom: 100
            };
        }
    }

    // Setup mouse events for a preview slide
    function setupImageDragAndZoom(slideIndex) {
        const previewSlide = document.getElementById(`preview_slide_${slideIndex}`);
        if (!previewSlide) return;

        initImageAdjustment(slideIndex);

        // Load saved values if available
        const posXInput = document.querySelector(`input[name="slide_${slideIndex}_image_pos_x"]`);
        const posYInput = document.querySelector(`input[name="slide_${slideIndex}_image_pos_y"]`);
        const zoomInput = document.querySelector(`input[name="slide_${slideIndex}_image_zoom"]`);

        if (posXInput && posXInput.value) imageAdjustments[slideIndex].posX = parseFloat(posXInput.value);
        if (posYInput && posYInput.value) imageAdjustments[slideIndex].posY = parseFloat(posYInput.value);
        if (zoomInput && zoomInput.value) imageAdjustments[slideIndex].zoom = parseFloat(zoomInput.value);

        applyImageAdjustment(slideIndex);

        // Mouse down - start dragging
        previewSlide.addEventListener('mousedown', function(e) {
            // Don't drag if clicking on buttons, text elements, resize handles, or other interactive elements
            if (e.target.closest('button') ||
                e.target.closest('a') ||
                e.target.closest('.resize-handle') ||
                e.target.closest('.preview-heading') ||
                e.target.closest('.preview-text') ||
                e.target.closest('.preview-content') ||
                e.target.closest('.preview-link-container')) return;

            isDragging = true;
            dragSlideIndex = slideIndex;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            previewSlide.classList.add('dragging');
            e.preventDefault();
        });

        // Mouse wheel - zoom
        previewSlide.addEventListener('wheel', function(e) {
            e.preventDefault();
            initImageAdjustment(slideIndex);
            const adj = imageAdjustments[slideIndex];

            const zoomStep = 5;
            if (e.deltaY < 0) {
                adj.zoom = Math.min(250, adj.zoom + zoomStep);
            } else {
                adj.zoom = Math.max(50, adj.zoom - zoomStep);
            }

            applyImageAdjustment(slideIndex);
        }, { passive: false });
    }

    // Global mouse move handler
    document.addEventListener('mousemove', function(e) {
        if (!isDragging || dragSlideIndex === null) return;

        const adj = imageAdjustments[dragSlideIndex];
        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;

        const sensitivity = 0.3;
        adj.posX = Math.max(0, Math.min(100, adj.posX - (deltaX * sensitivity)));
        adj.posY = Math.max(0, Math.min(100, adj.posY - (deltaY * sensitivity)));

        dragStartX = e.clientX;
        dragStartY = e.clientY;

        applyImageAdjustment(dragSlideIndex);
    });

    // Global mouse up handler
    document.addEventListener('mouseup', function() {
        if (isDragging && dragSlideIndex !== null) {
            const previewSlide = document.getElementById(`preview_slide_${dragSlideIndex}`);
            if (previewSlide) {
                previewSlide.classList.remove('dragging');
            }
        }
        isDragging = false;
        dragSlideIndex = null;
    });

    // Reset image position
    function resetImagePosition(slideIndex) {
        imageAdjustments[slideIndex] = {
            posX: 50,
            posY: 50,
            zoom: 100
        };
        applyImageAdjustment(slideIndex);
    }

    // Apply image adjustment to preview
    function applyImageAdjustment(slideIndex) {
        const previewSlide = document.getElementById(`preview_slide_${slideIndex}`);
        if (!previewSlide) return;

        const adj = imageAdjustments[slideIndex];
        previewSlide.style.backgroundPosition = `${adj.posX}% ${adj.posY}%`;
        previewSlide.style.backgroundSize = adj.zoom === 100 ? 'cover' : `${adj.zoom}%`;

        // Store in hidden inputs for form submission
        let posXInput = document.querySelector(`input[name="slide_${slideIndex}_image_pos_x"]`);
        let posYInput = document.querySelector(`input[name="slide_${slideIndex}_image_pos_y"]`);
        let zoomInput = document.querySelector(`input[name="slide_${slideIndex}_image_zoom"]`);

        const slideCard = document.querySelector(`#slide_${slideIndex}`);
        if (slideCard) {
            if (!posXInput) {
                posXInput = document.createElement('input');
                posXInput.type = 'hidden';
                posXInput.name = `slide_${slideIndex}_image_pos_x`;
                slideCard.appendChild(posXInput);
            }
            if (!posYInput) {
                posYInput = document.createElement('input');
                posYInput.type = 'hidden';
                posYInput.name = `slide_${slideIndex}_image_pos_y`;
                slideCard.appendChild(posYInput);
            }
            if (!zoomInput) {
                zoomInput = document.createElement('input');
                zoomInput.type = 'hidden';
                zoomInput.name = `slide_${slideIndex}_image_zoom`;
                slideCard.appendChild(zoomInput);
            }

            posXInput.value = adj.posX;
            posYInput.value = adj.posY;
            zoomInput.value = adj.zoom;
        }
    }

    // Form submit handler - sync CKEditor content before submission
    document.getElementById('webstoryForm').addEventListener('submit', function(e) {
        // Sync all CKEditor instances to their source elements
        for (const [key, editor] of Object.entries(editorInstances)) {
            if (editor && typeof editor.updateSourceElement === 'function') {
                editor.updateSourceElement();
            }
        }

        // Count actual slides and update slide_count
        const slideCards = document.querySelectorAll('.slide-card');
        document.getElementById('slide_count').value = slideCounter;

        // Allow form to submit
        return true;
    });
</script>
{% endblock %}