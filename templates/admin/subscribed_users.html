{% extends "admin/base.html" %}

{% block title %}Subscribed Users{% endblock %}

{% block page_title %}Subscribed Users{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Subscribed Users</li>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Stats cards -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body p-3">
                    <div class="stat-title">Total Subscriptions</div>
                    <div class="stat-value">{{ total_subscriptions }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body p-3">
                    <div class="stat-title">Active Subscriptions</div>
                    <div class="stat-value">{{ active_subscriptions }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body p-3">
                    <div class="stat-title">Expiring in 7 Days</div>
                    <div class="stat-value">{{ expiring_soon_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body p-3">
                    <div class="stat-title">Cancelled Subscriptions</div>
                    <div class="stat-value">{{ cancelled_subscriptions }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Actions -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-filter me-2"></i> Filters
            </div>
            <a href="{{ url_for('admin.admin_new_subscribed_user') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus-circle me-1"></i> Add New Subscription
            </a>
        </div>
        <div class="card-body">
            <form action="{{ url_for('admin.admin_subscribed_users') }}" method="GET" class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select name="status" id="status" class="form-select">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>Expired</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="plan" class="form-label">Subscription Plan</label>
                    <select name="plan" id="plan" class="form-select">
                        <option value="all" {% if plan_filter == 'all' %}selected{% endif %}>All Plans</option>
                        {% for plan in all_plans %}
                        <option value="{{ plan.S_ID }}" {% if plan_filter|int == plan.S_ID %}selected{% endif %}>
                            {{ plan.plan }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i> Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subscriptions Table -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-users me-2"></i> Subscribed Users
        </div>
        <div class="card-body p-0">
            <!-- DESKTOP TABLE VIEW -->
            <div class="d-none d-lg-block">
                <div class="subscribed-users-table-container">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Plan</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Daily Usage</th>
                                <th>Analytics</th>
                                <th>QR Codes</th>
                                <th>Scans Used</th>
                                <th>Auto-Renew</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub_user, user, subscription in subscribed_users %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ user.name }}</div>
                                    <div class="small text-muted">{{ user.company_email }}</div>
                                </td>
                                <td>{{ subscription.plan }}</td>
                                <td>{{ sub_user.start_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ sub_user.end_date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if sub_user._is_active and sub_user.end_date > now %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Active
                                        </span>
                                    {% elif not sub_user._is_active and sub_user.end_date > now %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-ban me-1"></i>Cancelled by User
                                        </span>
                                    {% elif sub_user.end_date <= now %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-clock me-1"></i>Expired
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hasattr(subscription, 'usage_per_day') and subscription.usage_per_day > 0 %}
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.daily_usage_percent > 90 else 'bg-success' }}" 
                                             role="progressbar" 
                                             style="width: {{ sub_user.daily_usage_percent }}%;" 
                                             aria-valuenow="{{ sub_user.daily_usage_percent }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="small mt-1">{{ sub_user.current_usage }} / {{ subscription.usage_per_day }} daily requests</div>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hasattr(subscription, 'analytics') and subscription.analytics > 0 %}
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.analytics_percent > 90 else 'bg-info' }}"
                                             role="progressbar"
                                             style="width: {{ sub_user.analytics_percent }}%;"
                                             aria-valuenow="{{ sub_user.analytics_percent }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="small mt-1">{{ sub_user.analytics_used }} / {{ sub_user.effective_analytics_limit }} analytics</div>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hasattr(subscription, 'qr_count') and subscription.qr_count > 0 %}
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.qr_percent > 90 else 'bg-primary' }}"
                                             role="progressbar"
                                             style="width: {{ sub_user.qr_percent }}%;"
                                             aria-valuenow="{{ sub_user.qr_percent }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="small mt-1">{{ sub_user.qr_generated }} / {{ sub_user.effective_qr_limit }} QR codes</div>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hasattr(subscription, 'scan_limit') and subscription.scan_limit > 0 %}
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.scan_percent > 90 else 'bg-warning' }}"
                                             role="progressbar"
                                             style="width: {{ sub_user.scan_percent }}%;"
                                             aria-valuenow="{{ sub_user.scan_percent }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="small mt-1">{{ sub_user.scans_used or 0 }} / {{ sub_user.effective_scan_limit }} scans</div>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sub_user.is_auto_renew %}
                                        <span class="badge bg-info">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex gap-1 justify-content-center">
                                        <a href="{{ url_for('admin.admin_edit_subscribed_user', id=sub_user.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Subscription">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-success open-modal-btn" data-modal-id="extendModal{{ sub_user.id }}" title="Extend Subscription">
                                            <i class="fas fa-calendar-plus"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger open-modal-btn" data-modal-id="deleteModal{{ sub_user.id }}" title="Delete Subscription">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center py-4">
                                    <div class="text-muted">No subscribed users found matching the filter criteria.</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MOBILE CARD VIEW -->
            <div class="d-lg-none">
                <div class="mobile-subscriptions-container">
                    {% for sub_user, user, subscription in subscribed_users %}
                    <div class="mobile-subscription-card">
                        <div class="mobile-card-header">
                            <div class="user-info">
                                <div class="fw-bold text-truncate">{{ user.name }}</div>
                                <div class="small text-muted text-truncate">{{ user.company_email }}</div>
                            </div>
                            <div class="plan-badge">
                                <span class="badge bg-info">{{ subscription.plan }}</span>
                            </div>
                        </div>
                        
                        <div class="mobile-card-body">
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <div class="info-item">
                                        <label class="small text-muted">Status</label>
                                        <div>
                                            {% if sub_user._is_active and sub_user.end_date > now %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i>Active
                                                </span>
                                            {% elif not sub_user._is_active and sub_user.end_date > now %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-ban me-1"></i>Cancelled
                                                </span>
                                            {% elif sub_user.end_date <= now %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-clock me-1"></i>Expired
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <label class="small text-muted">Auto-Renew</label>
                                        <div>
                                            {% if sub_user.is_auto_renew %}
                                                <span class="badge bg-info">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <div class="info-item">
                                        <label class="small text-muted">Start Date</label>
                                        <div class="small">{{ sub_user.start_date.strftime('%Y-%m-%d') }}</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-item">
                                        <label class="small text-muted">End Date</label>
                                        <div class="small">{{ sub_user.end_date.strftime('%Y-%m-%d') }}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="usage-section">
                                {% if hasattr(subscription, 'usage_per_day') and subscription.usage_per_day > 0 %}
                                <div class="usage-item">
                                    <label class="small text-muted">Daily Usage</label>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.daily_usage_percent > 90 else 'bg-success' }}" 
                                             style="width: {{ sub_user.daily_usage_percent }}%;"></div>
                                    </div>
                                    <div class="small">{{ sub_user.current_usage }} / {{ subscription.usage_per_day }}</div>
                                </div>
                                {% endif %}
                                
                                {% if hasattr(subscription, 'analytics') and subscription.analytics > 0 %}
                                <div class="usage-item">
                                    <label class="small text-muted">Analytics</label>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.analytics_percent > 90 else 'bg-info' }}"
                                             style="width: {{ sub_user.analytics_percent }}%;"></div>
                                    </div>
                                    <div class="small">{{ sub_user.analytics_used }} / {{ sub_user.effective_analytics_limit }}</div>
                                </div>
                                {% endif %}
                                
                                {% if hasattr(subscription, 'qr_count') and subscription.qr_count > 0 %}
                                <div class="usage-item">
                                    <label class="small text-muted">QR Codes</label>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.qr_percent > 90 else 'bg-primary' }}"
                                             style="width: {{ sub_user.qr_percent }}%;"></div>
                                    </div>
                                    <div class="small">{{ sub_user.qr_generated }} / {{ sub_user.effective_qr_limit }}</div>
                                </div>
                                {% endif %}
                                
                                {% if hasattr(subscription, 'scan_limit') and subscription.scan_limit > 0 %}
                                <div class="usage-item">
                                    <label class="small text-muted">Scans Used</label>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {{ 'bg-danger' if sub_user.scan_percent > 90 else 'bg-warning' }}"
                                             style="width: {{ sub_user.scan_percent }}%;"></div>
                                    </div>
                                    <div class="small">{{ sub_user.scans_used or 0 }} / {{ sub_user.effective_scan_limit }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mobile-card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="location.href='{{ url_for('admin.admin_edit_subscribed_user', id=sub_user.id) }}'">
                                <i class="fas fa-edit me-1"></i>Edit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success open-modal-btn" data-modal-id="extendModal{{ sub_user.id }}">
                                <i class="fas fa-calendar-plus me-1"></i>Extend
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger open-modal-btn" data-modal-id="deleteModal{{ sub_user.id }}">
                                <i class="fas fa-trash-alt me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="text-muted">No subscribed users found matching the filter criteria.</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals Container - Moved outside main container and positioned at body level -->
<div id="modals-container">
    {% for sub_user, user, subscription in subscribed_users %}
    <!-- Extend Modal -->
    <div id="extendModal{{ sub_user.id }}" class="custom-modal">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-container">
            <div class="custom-modal-content">
                <div class="custom-modal-header bg-success text-white">
                    <h5 class="custom-modal-title">
                        <i class="fas fa-calendar-plus me-2"></i> Extend Subscription
                    </h5>
                    <button type="button" class="btn-close btn-close-white close-modal-btn" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('admin.admin_extend_subscription', id=sub_user.id) }}" method="POST">
                    <div class="custom-modal-body">
                        <div class="text-center mb-3">
                            <p class="fw-bold mb-1">{{ user.name }}</p>
                            <p class="text-muted small mb-1">{{ user.company_email }}</p>
                            <span class="badge bg-info">{{ subscription.plan }}</span>
                        </div>
                        <div class="mb-3">
                            <label for="extension_days{{ sub_user.id }}" class="form-label">Extension Period (Days)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="extension_days{{ sub_user.id }}" name="extension_days" min="1" value="30" required>
                                <span class="input-group-text">days</span>
                            </div>
                            <div class="form-text small">Current expiration: {{ sub_user.end_date.strftime('%Y-%m-%d') }}</div>
                        </div>
                    </div>
                    <div class="custom-modal-footer">
                        <button type="button" class="btn btn-sm btn-outline-secondary close-modal-btn">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="fas fa-check me-1"></i> Confirm
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reactivate Modal - Only for Cancelled Subscriptions -->
{% if not sub_user._is_active and sub_user.end_date > now %}
<div id="reactivateModal{{ sub_user.id }}" class="custom-modal">
    <div class="custom-modal-overlay"></div>
    <div class="custom-modal-container">
        <div class="custom-modal-content">
            <div class="custom-modal-header bg-info text-white">
                <h5 class="custom-modal-title">
                    <i class="fas fa-play me-2"></i> Reactivate Subscription
                </h5>
                <button type="button" class="btn-close btn-close-white close-modal-btn" aria-label="Close"></button>
            </div>
            <div class="custom-modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-play fa-3x text-info mb-3"></i>
                    <h5>Reactivate Subscription?</h5>
                    <p>You are about to reactivate the subscription for:</p>
                    <p class="fw-bold">{{ user.name }}</p>
                    <p class="text-muted small text-break">({{ user.email }})</p>
                    <p>Plan: <span class="badge bg-info">{{ subscription.plan }}</span></p>
                    <p class="text-muted small">Subscription will remain valid until: {{ sub_user.end_date.strftime('%Y-%m-%d') }}</p>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button type="button" class="btn btn-outline-secondary close-modal-btn">Cancel</button>
                <form action="{{ url_for('admin.admin_reactivate_subscription', id=sub_user.id) }}" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-play me-1"></i> Reactivate
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
    
    <!-- Delete Modal -->
    <div id="deleteModal{{ sub_user.id }}" class="custom-modal">
        <div class="custom-modal-overlay"></div>
        <div class="custom-modal-container">
            <div class="custom-modal-content">
                <div class="custom-modal-header bg-danger text-white">
                    <h5 class="custom-modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i> Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white close-modal-btn" aria-label="Close"></button>
                </div>
                <div class="custom-modal-body text-center">
                    <div class="mb-4">
                        <i class="fas fa-trash-alt fa-4x text-danger mb-3"></i>
                        <h5>Delete Subscription?</h5>
                        <p>You are about to delete the subscription for:</p>
                        <p class="fw-bold">{{ user.name }} ({{ user.company_email }})</p>
                        <p>Plan: <span class="badge bg-info">{{ subscription.plan }}</span></p>
                    </div>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone.
                    </div>
                </div>
                <div class="custom-modal-footer">
                    <button type="button" class="btn btn-outline-secondary close-modal-btn">Cancel</button>
                    <form action="{{ url_for('admin.admin_delete_subscribed_user', id=sub_user.id) }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt me-1"></i> Delete Subscription
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add select2 for better dropdowns if available
    if (typeof $.fn.select2 !== 'undefined') {
        $('#status, #plan').select2({
            width: '100%'
        });
    }
    
    // Custom modal handling - completely independent from Bootstrap
    const openModalButtons = document.querySelectorAll('.open-modal-btn');
    const closeModalButtons = document.querySelectorAll('.close-modal-btn');
    const modalOverlays = document.querySelectorAll('.custom-modal-overlay');
    
    // Open modal function
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            // Ensure modal is attached to body for proper positioning
            if (modal.parentNode !== document.body) {
                document.body.appendChild(modal);
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            
            // Force reflow to ensure proper positioning
            modal.offsetHeight;
        }
    }
    
    // Close modal function
    function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }
    
    // Event listeners for opening modals
    openModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const modalId = this.getAttribute('data-modal-id');
            openModal(modalId);
        });
    });
    
    // Event listeners for closing modals
    closeModalButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const modal = this.closest('.custom-modal');
            closeModal(modal);
        });
    });
    
    // Close modal when clicking on overlay
    modalOverlays.forEach(overlay => {
        overlay.addEventListener('click', function(e) {
            if (e.target === this) {
                const modal = this.closest('.custom-modal');
                closeModal(modal);
            }
        });
    });
    
    // Close modal when pressing ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.custom-modal.active').forEach(modal => {
                closeModal(modal);
            });
        }
    });
    
    // Add animation to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 + (index * 50));
    });

    // Function to increment/decrement usage
    window.incrementUsage = function(userId, usageType, action) {
        const countInput = document.getElementById(`${usageType}-count-${userId}`) ||
                          document.getElementById(`${usageType}-count-mobile-${userId}`);
        const count = parseInt(countInput.value);

        if (count <= 0) {
            alert('Count must be positive!');
            return;
        }

        const endpoint = `/admin/subscribed-users/${action}-${usageType}/${userId}`;

        // Disable buttons during request
        const buttons = document.querySelectorAll(`button[onclick*="${userId}"][onclick*="${usageType}"]`);
        buttons.forEach(btn => btn.disabled = true);

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ count: count })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update both desktop and mobile elements
                const textElement = document.getElementById(`${usageType}-text-${userId}`);
                const textMobileElement = document.getElementById(`${usageType}-text-mobile-${userId}`);
                const progressElement = document.getElementById(`${usageType}-progress-${userId}`);
                const progressMobileElement = document.getElementById(`${usageType}-progress-mobile-${userId}`);

                const newText = `${data.used} / ${data.limit} ${usageType === 'analytics' ? 'analytics' : (usageType === 'qr' ? 'QR codes' : 'scans')}`;

                if (textElement) textElement.textContent = newText;
                if (textMobileElement) textMobileElement.textContent = `${data.used} / ${data.limit}`;

                if (progressElement) {
                    progressElement.style.width = `${data.percentage}%`;
                    progressElement.setAttribute('aria-valuenow', data.percentage);
                }
                if (progressMobileElement) {
                    progressMobileElement.style.width = `${data.percentage}%`;
                }

                // Update progress bar color based on percentage
                const colorClass = data.percentage > 90 ? 'bg-danger' :
                                 (usageType === 'analytics' ? 'bg-info' :
                                  (usageType === 'qr' ? 'bg-primary' : 'bg-warning'));

                if (progressElement) {
                    progressElement.className = `progress-bar ${colorClass}`;
                }
                if (progressMobileElement) {
                    progressMobileElement.className = `progress-bar ${colorClass}`;
                }

            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the usage count.');
        })
        .finally(() => {
            // Re-enable buttons
            buttons.forEach(btn => btn.disabled = false);
        });
    };
});
</script>

<style>
/* DESKTOP TABLE SCROLL CONTAINER */
.subscribed-users-table-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0.375rem;
}

.subscribed-users-table-container .table {
    margin-bottom: 0;
    min-width: 1200px; /* Increased for scan column */
}

.subscribed-users-table-container .table th,
.subscribed-users-table-container .table td {
    padding: 0.75rem;
    vertical-align: middle;
    white-space: nowrap;
}

.subscribed-users-table-container .table thead th {
    position: sticky;
    top: 0;
    background-color: var(--bs-gray-100);
    z-index: 10;
    border-bottom: 2px solid var(--bs-gray-300);
}

/* Custom scrollbar for desktop */
.subscribed-users-table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.subscribed-users-table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.subscribed-users-table-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.subscribed-users-table-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* MOBILE CARD VIEW */
.mobile-subscriptions-container {
    max-height: 450px;
    overflow-y: auto;
    padding: 0.75rem;
}

.mobile-subscription-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.2s ease;
}

.mobile-subscription-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.mobile-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
}

.user-info {
    flex: 1;
    min-width: 0;
    margin-right: 0.5rem;
}

.plan-badge {
    flex-shrink: 0;
}

.mobile-card-body {
    padding: 1rem;
}

.info-item {
    margin-bottom: 0.5rem;
}

.info-item label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.usage-section {
    border-top: 1px solid #e0e0e0;
    padding-top: 0.75rem;
    margin-top: 0.75rem;
}

.usage-item {
    margin-bottom: 0.5rem;
}

.usage-item label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.mobile-card-actions {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-top: 1px solid #e0e0e0;
}

.mobile-card-actions .btn {
    flex: 1;
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
}

/* Custom scrollbar for mobile */
.mobile-subscriptions-container::-webkit-scrollbar {
    width: 6px;
}

.mobile-subscriptions-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.mobile-subscriptions-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

/* MODAL STYLES */
.custom-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    pointer-events: none;
}

.custom-modal.active {
    display: block !important;
    pointer-events: auto;
}

.custom-modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    z-index: 10000 !important;
}

.custom-modal-container {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 10001 !important;
    width: auto !important;
    max-width: 400px !important;
    min-width: 300px !important;
    max-height: 90vh !important;
    overflow: hidden !important;
}

.custom-modal-content {
    background-color: #fff !important;
    border-radius: 0.5rem !important;
    box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
    overflow: hidden !important;
    max-height: 90vh !important;
    display: flex !important;
    flex-direction: column !important;
}

.custom-modal-header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 1rem 1.25rem !important;
    border-bottom: 1px solid #dee2e6 !important;
    flex-shrink: 0 !important;
}

.custom-modal-title {
    margin: 0 !important;
    font-size: 1.1rem !important;
    font-weight: 600 !important;
}

.custom-modal-body {
    padding: 1.25rem !important;
    overflow-y: auto !important;
    flex: 1 !important;
}

.custom-modal-footer {
    display: flex !important;
    justify-content: flex-end !important;
    align-items: center !important;
    gap: 0.75rem !important;
    padding: 1rem 1.25rem !important;
    border-top: 1px solid #dee2e6 !important;
    flex-shrink: 0 !important;
}

/* TEXT UTILITIES */
.text-break {
    word-wrap: break-word !important;
    word-break: break-word !important;
}

.text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* RESPONSIVE ADJUSTMENTS */
@media (max-width: 768px) {
    .subscribed-users-table-container {
        max-height: 350px;
    }
    
    .mobile-subscriptions-container {
        max-height: 400px;
        padding: 0.5rem;
    }
    
    .custom-modal-container {
        max-width: 90vw !important;
        min-width: 280px !important;
    }
    
    .custom-modal-header,
    .custom-modal-body,
    .custom-modal-footer {
        padding: 0.75rem 1rem !important;
    }
    
    .mobile-card-header,
    .mobile-card-body,
    .mobile-card-actions {
        padding: 0.75rem;
    }
    
    .mobile-card-actions .btn {
        font-size: 0.8rem;
        padding: 0.375rem 0.5rem;
    }
}

@media (max-width: 576px) {
    .mobile-subscriptions-container {
        max-height: 350px;
        padding: 0.25rem;
    }
    
    .custom-modal-container {
        max-width: 95vw !important;
        min-width: 260px !important;
    }
    
    .custom-modal-title {
        font-size: 1rem !important;
    }
    
    .mobile-subscription-card {
        margin-bottom: 0.75rem;
    }
    
    .mobile-card-header,
    .mobile-card-body,
    .mobile-card-actions {
        padding: 0.5rem;
    }
}

/* ANIMATION */
.custom-modal.active .custom-modal-container {
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translate(-50%, -60%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }
}

/* HOVER EFFECTS */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Ensure modals container doesn't interfere */
#modals-container {
    position: relative;
    z-index: 1;
}

/* Form elements within modals */
.custom-modal .form-label {
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.custom-modal .form-control {
    padding: 0.5rem 0.75rem;
}

.custom-modal .form-text {
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.custom-modal .alert {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
}

.custom-modal .input-group-text {
    padding: 0.5rem 0.75rem;
}

/* Button styles */
.custom-modal .btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
}

.btn-flash {
    animation: btn-flash 0.3s ease-out;
}

@keyframes btn-flash {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Hover effects for action buttons */
.btn-outline-primary:hover, .btn-outline-success:hover, .btn-outline-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: all 0.2s;
}

/* Ensure no container constraints affect modal */
.container-fluid, .container, .card {
    position: relative !important;
    z-index: auto !important;
}
</style>
{% endblock %}